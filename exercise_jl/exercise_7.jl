using CPUTime
using Plots
using DifferentialEquations
using LinearAlgebra
using Random



const L = 278e-3
const h = 64e-3
const H = 1104e-3
const L0 = 270.35e-3
const L1 = 69e-3
const L2 = 364.35e-3
const L3 = 69e-3
const L4 = 374.29e-3
const L5 = 10e-3
const L6 = 368.3e-3

s(x) = sin(x)
c(x) = cos(x)

"""世界座標系から見た局所座標系の原点座標をまとめて計算"""
function origins(q)



    o_Wo = [
        0
        0
        0
    ]

    o_BL = [
        L
        -h
        H
    ]

    o_0 = [
        L
        -h
        H + L0
    ]

    o_1 = [
        L
        -h
        H + L0
    ]

    o_2 = [
        L + c(π/4)*L1*s(q[1]) + c(π/4)*L1*c(q[1])
        c(π/4)*L1*s(q[1]) - c(π/4)*L1*c(q[1]) - h
        H + L0
    ]

    o_3 = [
        L + c(π/4)*L1*s(q[1]) + c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) + c(π/4)*L2*c(q[1])*c(q[2])
        c(π/4)*L1*s(q[1]) - c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) - c(π/4)*L2*c(q[1])*c(q[2]) - h
        H + L0 - L2*s(q[2])
    ]

    o_4 = [
        L + c(π/4)*L1*s(q[1]) + c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) + c(π/4)*L2*c(q[1])*c(q[2]) + c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))
        c(π/4)*L1*s(q[1]) - c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) - c(π/4)*L2*c(q[1])*c(q[2]) - c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1])) - h
        H + L0 - L2*s(q[2]) - L3*c(q[2])*c(q[3])
    ]

    o_5 = [
        L + c(π/4)*L1*s(q[1]) + c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) + c(π/4)*L2*c(q[1])*c(q[2]) + c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1])) - c(π/4)*L4*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4])) - c(π/4)*L4*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4]))
        c(π/4)*L1*s(q[1]) - c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) - c(π/4)*L2*c(q[1])*c(q[2]) - c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1])) + c(π/4)*L4*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4])) - c(π/4)*L4*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4])) - h
        H + L0 - L2*s(q[2]) - L3*c(q[2])*c(q[3]) - L4*(s(q[2])*c(q[4]) + s(q[4])*c(q[2])*c(q[3]))
    ]

    o_6 = [
        L + c(π/4)*L1*s(q[1]) + c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) + c(π/4)*L2*c(q[1])*c(q[2]) + c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1])) - c(π/4)*L4*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4])) - c(π/4)*L4*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4])) + c(π/4)*L5*(((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5])) + c(π/4)*L5*(((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + (s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[5]))
        c(π/4)*L1*s(q[1]) - c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) - c(π/4)*L2*c(q[1])*c(q[2]) - c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1])) + c(π/4)*L4*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4])) - c(π/4)*L4*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4])) - c(π/4)*L5*(((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5])) + c(π/4)*L5*(((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + (s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[5])) - h
        H + L0 - L2*s(q[2]) - L3*c(q[2])*c(q[3]) - L4*(s(q[2])*c(q[4]) + s(q[4])*c(q[2])*c(q[3])) + L5*((s(q[2])*s(q[4]) - c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + s(q[3])*s(q[5])*c(q[2]))
    ]

    o_7 = [
        L + c(π/4)*L1*s(q[1]) + c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) + c(π/4)*L2*c(q[1])*c(q[2]) + c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1])) - c(π/4)*L4*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4])) - c(π/4)*L4*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4])) + c(π/4)*L5*(((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5])) + c(π/4)*L5*(((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + (s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[5]))
        c(π/4)*L1*s(q[1]) - c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) - c(π/4)*L2*c(q[1])*c(q[2]) - c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1])) + c(π/4)*L4*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4])) - c(π/4)*L4*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4])) - c(π/4)*L5*(((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5])) + c(π/4)*L5*(((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + (s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[5])) - h
        H + L0 - L2*s(q[2]) - L3*c(q[2])*c(q[3]) - L4*(s(q[2])*c(q[4]) + s(q[4])*c(q[2])*c(q[3])) + L5*((s(q[2])*s(q[4]) - c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + s(q[3])*s(q[5])*c(q[2]))
    ]

    o_GL = [
        L + c(π/4)*L1*s(q[1]) + c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) + c(π/4)*L2*c(q[1])*c(q[2]) + c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1])) - c(π/4)*L4*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4])) - c(π/4)*L4*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4])) + c(π/4)*L5*(((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5])) + c(π/4)*L5*(((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + (s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[5])) + L6*(c(π/4)*(((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5]))*s(q[6]) + c(π/4)*(((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + (s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[5]))*s(q[6]) + c(π/4)*((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) + c(q[1])*c(q[2])*c(q[4]))*c(q[6]) + c(π/4)*((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) + s(q[1])*c(q[2])*c(q[4]))*c(q[6]))
        c(π/4)*L1*s(q[1]) - c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) - c(π/4)*L2*c(q[1])*c(q[2]) - c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1])) + c(π/4)*L4*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4])) - c(π/4)*L4*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4])) - c(π/4)*L5*(((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5])) + c(π/4)*L5*(((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + (s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[5])) + L6*(-c(π/4)*(((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5]))*s(q[6]) + c(π/4)*(((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + (s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[5]))*s(q[6]) - c(π/4)*((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) + c(q[1])*c(q[2])*c(q[4]))*c(q[6]) + c(π/4)*((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) + s(q[1])*c(q[2])*c(q[4]))*c(q[6])) - h
        H + L0 - L2*s(q[2]) - L3*c(q[2])*c(q[3]) - L4*(s(q[2])*c(q[4]) + s(q[4])*c(q[2])*c(q[3])) + L5*((s(q[2])*s(q[4]) - c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + s(q[3])*s(q[5])*c(q[2])) + L6*(((s(q[2])*s(q[4]) - c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + s(q[3])*s(q[5])*c(q[2]))*s(q[6]) + (-s(q[2])*c(q[4]) - s(q[4])*c(q[2])*c(q[3]))*c(q[6]))
    ]

    return [o_Wo o_BL o_0 o_1 o_2 o_3 o_4 o_5 o_6 o_7 o_GL]
end

"""ヤコビ行列"""
function jacobi_GL(q)
    z = [
        -c(π/4)*L1*s(q[1]) + c(π/4)*L1*c(q[1]) - c(π/4)*L2*s(q[1])*c(q[2]) + c(π/4)*L2*c(q[1])*c(q[2]) + c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) + c(π/4)*L3*(s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1])) - c(π/4)*L4*((s(q[1])*s(q[3]) + s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4])) - c(π/4)*L4*((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) + s(q[1])*c(q[2])*c(q[4])) + c(π/4)*L5*(((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5])) + c(π/4)*L5*(((s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*c(q[4]) + s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + (-s(q[1])*s(q[2])*s(q[3]) - c(q[1])*c(q[3]))*s(q[5])) + L6*((c(π/4)*((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + c(π/4)*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5]))*s(q[6]) + (c(π/4)*((s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*c(q[4]) + s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + c(π/4)*(-s(q[1])*s(q[2])*s(q[3]) - c(q[1])*c(q[3]))*s(q[5]))*s(q[6]) + (c(π/4)*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) + c(π/4)*c(q[1])*c(q[2])*c(q[4]))*c(q[6]) + (c(π/4)*(s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*s(q[4]) - c(π/4)*s(q[1])*c(q[2])*c(q[4]))*c(q[6])) -c(π/4)*L2*s(q[1])*s(q[2]) - c(π/4)*L2*s(q[2])*c(q[1]) - c(π/4)*L3*s(q[1])*c(q[2])*c(q[3]) - c(π/4)*L3*c(q[1])*c(q[2])*c(q[3]) - c(π/4)*L4*(s(q[1])*s(q[2])*c(q[4]) + s(q[1])*s(q[4])*c(q[2])*c(q[3])) - c(π/4)*L4*(s(q[2])*c(q[1])*c(q[4]) + s(q[4])*c(q[1])*c(q[2])*c(q[3])) + c(π/4)*L5*((s(q[1])*s(q[2])*s(q[4]) - s(q[1])*c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + s(q[1])*s(q[3])*s(q[5])*c(q[2])) + c(π/4)*L5*((s(q[2])*s(q[4])*c(q[1]) - c(q[1])*c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + s(q[3])*s(q[5])*c(q[1])*c(q[2])) + L6*((c(π/4)*(s(q[1])*s(q[2])*s(q[4]) - s(q[1])*c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + c(π/4)*s(q[1])*s(q[3])*s(q[5])*c(q[2]))*s(q[6]) + (c(π/4)*(s(q[2])*s(q[4])*c(q[1]) - c(q[1])*c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + c(π/4)*s(q[3])*s(q[5])*c(q[1])*c(q[2]))*s(q[6]) + (-c(π/4)*s(q[1])*s(q[2])*c(q[4]) - c(π/4)*s(q[1])*s(q[4])*c(q[2])*c(q[3]))*c(q[6]) + (-c(π/4)*s(q[2])*c(q[1])*c(q[4]) - c(π/4)*s(q[4])*c(q[1])*c(q[2])*c(q[3]))*c(q[6])) c(π/4)*L3*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1])) + c(π/4)*L3*(s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3])) - c(π/4)*L4*(s(q[1])*c(q[3]) - s(q[2])*s(q[3])*c(q[1]))*s(q[4]) - c(π/4)*L4*(-s(q[1])*s(q[2])*s(q[3]) - c(q[1])*c(q[3]))*s(q[4]) + c(π/4)*L5*((s(q[1])*s(q[3]) + s(q[2])*c(q[1])*c(q[3]))*s(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*c(q[4])*c(q[5])) + c(π/4)*L5*((s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*c(q[4])*c(q[5]) + (s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*s(q[5])) + L6*((c(π/4)*(s(q[1])*s(q[3]) + s(q[2])*c(q[1])*c(q[3]))*s(q[5]) + c(π/4)*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*c(q[4])*c(q[5]))*s(q[6]) + c(π/4)*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[4])*c(q[6]) + (c(π/4)*(s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*c(q[4])*c(q[5]) + c(π/4)*(s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*s(q[5]))*s(q[6]) + c(π/4)*(s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[4])*c(q[6])) -c(π/4)*L4*((s(q[1])*s(q[3]) + s(q[2])*c(q[1])*c(q[3]))*c(q[4]) + s(q[4])*c(q[1])*c(q[2])) - c(π/4)*L4*((s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*c(q[4]) + s(q[1])*s(q[4])*c(q[2])) + c(π/4)*L5*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4]))*c(q[5]) + c(π/4)*L5*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4]))*c(q[5]) + L6*(c(π/4)*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4]))*s(q[6])*c(q[5]) + (c(π/4)*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - c(π/4)*s(q[4])*c(q[1])*c(q[2]))*c(q[6]) + c(π/4)*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4]))*s(q[6])*c(q[5]) + (c(π/4)*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - c(π/4)*s(q[1])*s(q[4])*c(q[2]))*c(q[6])) c(π/4)*L5*(-((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*s(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*c(q[5])) + c(π/4)*L5*(-((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*s(q[5]) + (s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*c(q[5])) + L6*((-c(π/4)*((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*s(q[5]) + c(π/4)*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*c(q[5]))*s(q[6]) + (-c(π/4)*((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*s(q[5]) + c(π/4)*(s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*c(q[5]))*s(q[6])) L6*((c(π/4)*((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + c(π/4)*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5]))*c(q[6]) + (c(π/4)*((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + c(π/4)*(s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[5]))*c(q[6]) - (c(π/4)*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) + c(π/4)*c(q[1])*c(q[2])*c(q[4]))*s(q[6]) - (c(π/4)*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) + c(π/4)*s(q[1])*c(q[2])*c(q[4]))*s(q[6])) 0
        c(π/4)*L1*s(q[1]) + c(π/4)*L1*c(q[1]) + c(π/4)*L2*s(q[1])*c(q[2]) + c(π/4)*L2*c(q[1])*c(q[2]) + c(π/4)*L3*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3])) - c(π/4)*L3*(s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1])) - c(π/4)*L4*((s(q[1])*s(q[3]) + s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4])) + c(π/4)*L4*((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) + s(q[1])*c(q[2])*c(q[4])) + c(π/4)*L5*(((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5])) - c(π/4)*L5*(((s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*c(q[4]) + s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + (-s(q[1])*s(q[2])*s(q[3]) - c(q[1])*c(q[3]))*s(q[5])) + L6*((c(π/4)*((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) + c(π/4)*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5]))*s(q[6]) + (-c(π/4)*((s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*c(q[4]) + s(q[1])*s(q[4])*c(q[2]))*c(q[5]) - c(π/4)*(-s(q[1])*s(q[2])*s(q[3]) - c(q[1])*c(q[3]))*s(q[5]))*s(q[6]) + (c(π/4)*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) + c(π/4)*c(q[1])*c(q[2])*c(q[4]))*c(q[6]) + (-c(π/4)*(s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*s(q[4]) + c(π/4)*s(q[1])*c(q[2])*c(q[4]))*c(q[6])) -c(π/4)*L2*s(q[1])*s(q[2]) + c(π/4)*L2*s(q[2])*c(q[1]) - c(π/4)*L3*s(q[1])*c(q[2])*c(q[3]) + c(π/4)*L3*c(q[1])*c(q[2])*c(q[3]) - c(π/4)*L4*(s(q[1])*s(q[2])*c(q[4]) + s(q[1])*s(q[4])*c(q[2])*c(q[3])) + c(π/4)*L4*(s(q[2])*c(q[1])*c(q[4]) + s(q[4])*c(q[1])*c(q[2])*c(q[3])) + c(π/4)*L5*((s(q[1])*s(q[2])*s(q[4]) - s(q[1])*c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + s(q[1])*s(q[3])*s(q[5])*c(q[2])) - c(π/4)*L5*((s(q[2])*s(q[4])*c(q[1]) - c(q[1])*c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + s(q[3])*s(q[5])*c(q[1])*c(q[2])) + L6*((c(π/4)*(s(q[1])*s(q[2])*s(q[4]) - s(q[1])*c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + c(π/4)*s(q[1])*s(q[3])*s(q[5])*c(q[2]))*s(q[6]) + (-c(π/4)*(s(q[2])*s(q[4])*c(q[1]) - c(q[1])*c(q[2])*c(q[3])*c(q[4]))*c(q[5]) - c(π/4)*s(q[3])*s(q[5])*c(q[1])*c(q[2]))*s(q[6]) + (-c(π/4)*s(q[1])*s(q[2])*c(q[4]) - c(π/4)*s(q[1])*s(q[4])*c(q[2])*c(q[3]))*c(q[6]) + (c(π/4)*s(q[2])*c(q[1])*c(q[4]) + c(π/4)*s(q[4])*c(q[1])*c(q[2])*c(q[3]))*c(q[6])) -c(π/4)*L3*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1])) + c(π/4)*L3*(s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3])) + c(π/4)*L4*(s(q[1])*c(q[3]) - s(q[2])*s(q[3])*c(q[1]))*s(q[4]) - c(π/4)*L4*(-s(q[1])*s(q[2])*s(q[3]) - c(q[1])*c(q[3]))*s(q[4]) - c(π/4)*L5*((s(q[1])*s(q[3]) + s(q[2])*c(q[1])*c(q[3]))*s(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*c(q[4])*c(q[5])) + c(π/4)*L5*((s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*c(q[4])*c(q[5]) + (s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*s(q[5])) + L6*((-c(π/4)*(s(q[1])*s(q[3]) + s(q[2])*c(q[1])*c(q[3]))*s(q[5]) - c(π/4)*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*c(q[4])*c(q[5]))*s(q[6]) - c(π/4)*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[4])*c(q[6]) + (c(π/4)*(s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*c(q[4])*c(q[5]) + c(π/4)*(s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*s(q[5]))*s(q[6]) + c(π/4)*(s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[4])*c(q[6])) c(π/4)*L4*((s(q[1])*s(q[3]) + s(q[2])*c(q[1])*c(q[3]))*c(q[4]) + s(q[4])*c(q[1])*c(q[2])) - c(π/4)*L4*((s(q[1])*s(q[2])*c(q[3]) - s(q[3])*c(q[1]))*c(q[4]) + s(q[1])*s(q[4])*c(q[2])) - c(π/4)*L5*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4]))*c(q[5]) + c(π/4)*L5*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4]))*c(q[5]) + L6*(-c(π/4)*(-(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(q[1])*c(q[2])*c(q[4]))*s(q[6])*c(q[5]) + (-c(π/4)*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) + c(π/4)*s(q[4])*c(q[1])*c(q[2]))*c(q[6]) + c(π/4)*(-(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) - s(q[1])*c(q[2])*c(q[4]))*s(q[6])*c(q[5]) + (c(π/4)*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - c(π/4)*s(q[1])*s(q[4])*c(q[2]))*c(q[6])) -c(π/4)*L5*(-((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*s(q[5]) + (-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*c(q[5])) + c(π/4)*L5*(-((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*s(q[5]) + (s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*c(q[5])) + L6*((c(π/4)*((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*s(q[5]) - c(π/4)*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*c(q[5]))*s(q[6]) + (-c(π/4)*((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*s(q[5]) + c(π/4)*(s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*c(q[5]))*s(q[6])) L6*((-c(π/4)*((-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*c(q[4]) - s(q[4])*c(q[1])*c(q[2]))*c(q[5]) - c(π/4)*(-s(q[1])*c(q[3]) + s(q[2])*s(q[3])*c(q[1]))*s(q[5]))*c(q[6]) + (c(π/4)*((-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*c(q[4]) - s(q[1])*s(q[4])*c(q[2]))*c(q[5]) + c(π/4)*(s(q[1])*s(q[2])*s(q[3]) + c(q[1])*c(q[3]))*s(q[5]))*c(q[6]) - (-c(π/4)*(-s(q[1])*s(q[3]) - s(q[2])*c(q[1])*c(q[3]))*s(q[4]) - c(π/4)*c(q[1])*c(q[2])*c(q[4]))*s(q[6]) - (c(π/4)*(-s(q[1])*s(q[2])*c(q[3]) + s(q[3])*c(q[1]))*s(q[4]) + c(π/4)*s(q[1])*c(q[2])*c(q[4]))*s(q[6])) 0
        0 -L2*c(q[2]) + L3*s(q[2])*c(q[3]) - L4*(-s(q[2])*s(q[4])*c(q[3]) + c(q[2])*c(q[4])) + L5*((s(q[2])*c(q[3])*c(q[4]) + s(q[4])*c(q[2]))*c(q[5]) - s(q[2])*s(q[3])*s(q[5])) + L6*(((s(q[2])*c(q[3])*c(q[4]) + s(q[4])*c(q[2]))*c(q[5]) - s(q[2])*s(q[3])*s(q[5]))*s(q[6]) + (s(q[2])*s(q[4])*c(q[3]) - c(q[2])*c(q[4]))*c(q[6])) L3*s(q[3])*c(q[2]) + L4*s(q[3])*s(q[4])*c(q[2]) + L5*(s(q[3])*c(q[2])*c(q[4])*c(q[5]) + s(q[5])*c(q[2])*c(q[3])) + L6*((s(q[3])*c(q[2])*c(q[4])*c(q[5]) + s(q[5])*c(q[2])*c(q[3]))*s(q[6]) + s(q[3])*s(q[4])*c(q[2])*c(q[6])) -L4*(-s(q[2])*s(q[4]) + c(q[2])*c(q[3])*c(q[4])) + L5*(s(q[2])*c(q[4]) + s(q[4])*c(q[2])*c(q[3]))*c(q[5]) + L6*((s(q[2])*s(q[4]) - c(q[2])*c(q[3])*c(q[4]))*c(q[6]) + (s(q[2])*c(q[4]) + s(q[4])*c(q[2])*c(q[3]))*s(q[6])*c(q[5])) L5*(-(s(q[2])*s(q[4]) - c(q[2])*c(q[3])*c(q[4]))*s(q[5]) + s(q[3])*c(q[2])*c(q[5])) + L6*(-(s(q[2])*s(q[4]) - c(q[2])*c(q[3])*c(q[4]))*s(q[5]) + s(q[3])*c(q[2])*c(q[5]))*s(q[6]) L6*(((s(q[2])*s(q[4]) - c(q[2])*c(q[3])*c(q[4]))*c(q[5]) + s(q[3])*s(q[5])*c(q[2]))*c(q[6]) - (-s(q[2])*c(q[4]) - s(q[4])*c(q[2])*c(q[3]))*s(q[6])) 0
    ]
    return z
end




"""逆運動学を解く"""
function inv_kinematics(xd, trial=10, α=1, allowance_error=0.001)

    q1_min, q1_max = -141, 51
    q2_min, q2_max = -123, 60
    q3_min, q3_max = -173, 173
    q4_min, q4_max = -3, 150
    q5_min, q5_max = -175, 175
    q6_min, q6_max = -90, 120
    q7_min, q7_max = -175, 175
    q_min = [q1_min, q2_min, q3_min, q4_min, q5_min, q6_min, q7_min] * π / 180
    q_max = [q1_max, q2_max, q3_max, q4_max, q5_max, q6_max, q7_max] * π / 180

    Δt = 0.01
    for i in 1:trial
        println(i, "回目の試行")
        global q = (rand((7)) .-0.5) .* π  # ランダムな初期値
        for t in 0:Δt:10
            Δx = xd - origins(q)[:, 11]
            error = norm(Δx)
            if error < allowance_error
                break
            else
                dq = α * πnv(jacobi_GL(q)) * Δx
                global q += dq * Δt
            end
        end
        
        if q_min <= q <= q_max
            return q
        else
            continue
        end
    end
end



function ex()
    xd = [0.3, -0.6, 1]  # 所望のエンドエフェクタ位置
    qd = inv_kinematics(xd)  # 逆運動学の解を計算

    ### plot ###
    plot(aspect_ratio=1, xlabel="x", ylabel="y", zlabel="z")
    plot!(
        [xd[1]], [xd[2]], [xd[3]],
        marker=:circle, markersize = 10, label="desired ef position"
    )


    data = origins(qd)  # アームの位置データを用意
    plot!(data[1, :], data[2, :], data[3, :], marker=:circle, label="arm")
end



@time ex()
